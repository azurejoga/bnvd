name: 'BNVD Dependabot CVE Enricher'
description: 'Enriquece alertas Dependabot com informacoes CVE em portugues do BNVD'
author: 'BNVD Team'

branding:
  icon: 'shield'
  color: 'green'

inputs:
  bnvd_api_url:
    description: 'URL base da API BNVD'
    required: false
    default: 'https://bnvd.org/api/v1'
  github_token:
    description: 'GitHub token para acessar alerts do Dependabot'
    required: true
  include_translations:
    description: 'Incluir traducoes em portugues'
    required: false
    default: 'true'
  severity_filter:
    description: 'Filtrar por severidade (LOW, MEDIUM, HIGH, CRITICAL, ALL)'
    required: false
    default: 'ALL'
  create_issues:
    description: 'Criar issues para cada CVE encontrada'
    required: false
    default: 'false'
  issue_labels:
    description: 'Labels para as issues criadas (separados por virgula)'
    required: false
    default: 'security,cve,bnvd'

outputs:
  total_alerts:
    description: 'Numero total de alertas processados'
  enriched_alerts:
    description: 'Numero de alertas enriquecidos com sucesso'
  cve_details:
    description: 'JSON com detalhes das CVEs encontradas'
  report_file:
    description: 'Caminho para o arquivo de relatorio gerado'

runs:
  using: 'composite'
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      shell: bash
      run: |
        pip install requests
    
    - name: Process Dependabot Alerts
      id: process
      shell: python
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        BNVD_API_URL: ${{ inputs.bnvd_api_url }}
        INCLUDE_TRANSLATIONS: ${{ inputs.include_translations }}
        SEVERITY_FILTER: ${{ inputs.severity_filter }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        import os
        import json
        import requests
        from datetime import datetime
        
        GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN')
        BNVD_API_URL = os.environ.get('BNVD_API_URL', 'https://bnvd.org/api/v1')
        INCLUDE_TRANSLATIONS = os.environ.get('INCLUDE_TRANSLATIONS', 'true').lower() == 'true'
        SEVERITY_FILTER = os.environ.get('SEVERITY_FILTER', 'ALL').upper()
        REPO = os.environ.get('GITHUB_REPOSITORY')
        
        def get_dependabot_alerts():
            """Busca alertas do Dependabot via GitHub API"""
            headers = {
                'Authorization': f'Bearer {GITHUB_TOKEN}',
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
            }
            
            url = f'https://api.github.com/repos/{REPO}/dependabot/alerts'
            params = {'state': 'open', 'per_page': 100}
            
            response = requests.get(url, headers=headers, params=params)
            
            if response.status_code == 200:
                return response.json()
            else:
                print(f"Erro ao buscar alertas: {response.status_code}")
                return []
        
        def get_cve_from_bnvd(cve_id):
            """Busca detalhes do CVE na API BNVD"""
            try:
                url = f"{BNVD_API_URL}/vulnerabilities/{cve_id}"
                params = {'include_pt': str(INCLUDE_TRANSLATIONS).lower()}
                
                response = requests.get(url, params=params, timeout=30)
                
                if response.status_code == 200:
                    data = response.json()
                    if data.get('status') == 'success':
                        return data.get('data')
                return None
            except Exception as e:
                print(f"Erro ao buscar {cve_id} no BNVD: {e}")
                return None
        
        def filter_by_severity(cve_data, severity_filter):
            """Filtra CVE por severidade"""
            if severity_filter == 'ALL':
                return True
            
            cvss_metrics = cve_data.get('cvss_metrics', {})
            if isinstance(cvss_metrics, str):
                cvss_metrics = json.loads(cvss_metrics)
            
            for version in ['cvssMetricV31', 'cvssMetricV30', 'cvssMetricV2']:
                if version in cvss_metrics:
                    metrics = cvss_metrics[version]
                    if isinstance(metrics, list) and len(metrics) > 0:
                        severity = metrics[0].get('cvssData', {}).get('baseSeverity', '')
                        if severity.upper() == severity_filter:
                            return True
            return False
        
        def generate_report(enriched_alerts):
            """Gera relatorio em formato Markdown"""
            report = []
            report.append("# Relatorio BNVD - Alertas de Seguranca\n")
            report.append(f"**Data:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            report.append(f"**Repositorio:** {REPO}\n")
            report.append(f"**Total de Alertas:** {len(enriched_alerts)}\n\n")
            
            if not enriched_alerts:
                report.append("Nenhum alerta de seguranca encontrado.\n")
                return '\n'.join(report)
            
            report.append("## Vulnerabilidades Encontradas\n")
            
            for alert in enriched_alerts:
                cve_id = alert.get('cve_id', 'N/A')
                bnvd_data = alert.get('bnvd_data', {})
                
                report.append(f"### {cve_id}\n")
                
                if bnvd_data:
                    descriptions = bnvd_data.get('descriptions', [])
                    if isinstance(descriptions, str):
                        descriptions = json.loads(descriptions)
                    
                    desc_pt = bnvd_data.get('descriptions_pt', [])
                    
                    if desc_pt and len(desc_pt) > 0:
                        report.append(f"**Descricao (PT):** {desc_pt[0].get('value', 'N/A')}\n")
                    elif descriptions and len(descriptions) > 0:
                        for desc in descriptions:
                            if desc.get('lang') == 'en':
                                report.append(f"**Descricao (EN):** {desc.get('value', 'N/A')}\n")
                                break
                    
                    cvss_metrics = bnvd_data.get('cvss_metrics', {})
                    if isinstance(cvss_metrics, str):
                        cvss_metrics = json.loads(cvss_metrics)
                    
                    for version in ['cvssMetricV31', 'cvssMetricV30']:
                        if version in cvss_metrics:
                            metrics = cvss_metrics[version]
                            if isinstance(metrics, list) and len(metrics) > 0:
                                cvss_data = metrics[0].get('cvssData', {})
                                score = cvss_data.get('baseScore', 'N/A')
                                severity = cvss_data.get('baseSeverity', 'N/A')
                                report.append(f"**Score CVSS:** {score}/10.0 ({severity})\n")
                                break
                    
                    report.append(f"**Link BNVD:** https://bnvd.org/vulnerabilidade/{cve_id}\n")
                    report.append(f"**Analisar com IA:** https://chat.openai.com/?q=Analise%20a%20vulnerabilidade%20{cve_id}\n")
                else:
                    report.append("_Dados nao disponiveis no BNVD_\n")
                
                report.append("\n---\n")
            
            return '\n'.join(report)
        
        # Processar alertas
        print("Buscando alertas do Dependabot...")
        alerts = get_dependabot_alerts()
        print(f"Encontrados {len(alerts)} alertas")
        
        enriched_alerts = []
        
        for alert in alerts:
            cve_id = None
            
            advisory = alert.get('security_advisory', {})
            identifiers = advisory.get('identifiers', [])
            
            for identifier in identifiers:
                if identifier.get('type') == 'CVE':
                    cve_id = identifier.get('value')
                    break
            
            if not cve_id:
                continue
            
            print(f"Processando {cve_id}...")
            
            bnvd_data = get_cve_from_bnvd(cve_id)
            
            if bnvd_data and filter_by_severity(bnvd_data, SEVERITY_FILTER):
                enriched_alerts.append({
                    'cve_id': cve_id,
                    'github_alert': {
                        'number': alert.get('number'),
                        'state': alert.get('state'),
                        'severity': advisory.get('severity'),
                        'package': alert.get('dependency', {}).get('package', {}).get('name')
                    },
                    'bnvd_data': bnvd_data
                })
        
        print(f"Enriquecidos {len(enriched_alerts)} alertas com dados BNVD")
        
        report = generate_report(enriched_alerts)
        
        report_file = 'bnvd-security-report.md'
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(report)
        
        print(f"Relatorio salvo em {report_file}")
        
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"total_alerts={len(alerts)}\n")
            f.write(f"enriched_alerts={len(enriched_alerts)}\n")
            f.write(f"report_file={report_file}\n")
        
        cve_summary = [{'cve_id': a['cve_id'], 'severity': a['github_alert']['severity']} for a in enriched_alerts]
        print(f"::set-output name=cve_details::{json.dumps(cve_summary)}")
    
    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: bnvd-security-report
        path: bnvd-security-report.md
        retention-days: 30
