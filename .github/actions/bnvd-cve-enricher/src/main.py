# -*- coding: utf-8 -*-
import os
import json
import sys
import requests
from datetime import datetime
from github import Github

def get_bnvd_data(cve_id, bnvd_api_url, include_translations):
    """Busca detalhes de um CVE na API do BNVD."""
    if not cve_id:
        return None
    try:
        url = f"{bnvd_api_url}/vulnerabilities/{cve_id}"
        params = {'include_pt': str(include_translations).lower()}
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()  # Lança exceção para respostas 4xx/5xx
        if response.status_code == 200:
            data = response.json()
            if data.get('status') == 'success':
                return data.get('data')
        return None
    except requests.exceptions.RequestException as e:
        # Apenas avisa, mas não para a execução, pois um CVE pode não estar no BNVD
        print(f"Alerta: Não foi possível buscar {cve_id} no BNVD: {e}")
        return None

def get_dependabot_alerts(repo):
    """Busca alertas do Dependabot que estão abertos."""
    print("Buscando alertas do Dependabot...")
    alerts = []
    try:
        for alert in repo.get_dependabot_alerts(state="open"):
            if alert.security_advisory.cve_id:
                alerts.append({
                    "type": "Dependabot",
                    "cve_id": alert.security_advisory.cve_id,
                    "package": alert.dependency.package.name,
                    "severity": alert.security_advisory.severity,
                    "url": alert.html_url,
                    "number": alert.number
                })
    except Exception as e:
        print(f"Erro fatal ao buscar alertas do Dependabot: {e}")
        print("Verifique se o workflow tem a permissão 'security-events: read'.")
        sys.exit(1)
    print(f"Encontrados {len(alerts)} alertas do Dependabot com CVE.")
    return alerts

def get_codeql_alerts(repo):
    """Busca alertas do CodeQL e extrai os CVEs."""
    print("Buscando alertas de Code Scanning (CodeQL)...")
    alerts = []
    try:
        for alert in repo.get_code_scanning_alerts(state="open"):
            cve_id = None
            if alert.rule.tags:
                for tag in alert.rule.tags:
                    if tag.startswith('external/cve/'):
                        # Formato esperado: 'external/cve/cve-2021-44228'
                        cve_id = tag.split('/')[-1].upper()
                        break
            if cve_id:
                alerts.append({
                    "type": "CodeQL",
                    "cve_id": cve_id,
                    "description": alert.rule.description,
                    "severity": alert.rule.security_severity_level,
                    "url": alert.html_url,
                    "number": alert.number
                })
    except Exception as e:
        print(f"Erro fatal ao buscar alertas do CodeQL: {e}")
        print("Verifique se o workflow tem a permissão 'security-events: read'.")
        sys.exit(1)
    print(f"Encontrados {len(alerts)} alertas do CodeQL com CVE.")
    return alerts

def filter_by_severity(severity, severity_filter):
    """Filtra um alerta pela severidade."""
    if severity_filter == 'ALL':
        return True
    # Mapeia severidades do GitHub para um padrão (LOW, MEDIUM, HIGH, CRITICAL)
    severity_map = {
        "low": "LOW",
        "moderate": "MEDIUM",
        "medium": "MEDIUM",
        "high": "HIGH",
        "critical": "CRITICAL"
    }
    return severity_map.get(severity.lower(), "UNKNOWN") == severity_filter

def generate_report(enriched_alerts, repo_name):
    """Gera um relatório em formato Markdown."""
    report = [f"# Relatório de Segurança BNVD - {repo_name}\n"]
    report.append(f"**Data:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    report.append(f"**Total de Vulnerabilidades Encontradas:** {len(enriched_alerts)}\n\n")

    if not enriched_alerts:
        report.append("Nenhuma vulnerabilidade com CVE encontrado ou que corresponda ao filtro de severidade.\n")
        return '\n'.join(report)

    report.append("## Detalhes das Vulnerabilidades\n")
    for alert in sorted(enriched_alerts, key=lambda x: x.get('bnvd_data', {}).get('cvss_score', 0), reverse=True):
        cve_id = alert.get('cve_id', 'N/A')
        bnvd_data = alert.get('bnvd_data')
        alert_type = alert.get('type', 'N/A')
        
        report.append(f"### {cve_id} (Origem: {alert_type})\n")
        
        if bnvd_data:
            desc_pt = next((d['value'] for d in bnvd_data.get('descriptions_pt', []) if d.get('value')), None)
            desc_en = next((d['value'] for d in bnvd_data.get('descriptions', []) if d.get('lang') == 'en' and d.get('value')), 'N/A')

            if desc_pt:
                report.append(f"**Descrição (PT):** {desc_pt}\n")
            else:
                report.append(f"**Descrição (EN):** {desc_en}\n")

            cvss_score = bnvd_data.get('cvss_score', 'N/A')
            cvss_severity = bnvd_data.get('cvss_severity', 'N/A')
            report.append(f"**Score CVSS:** {cvss_score}/10.0 ({cvss_severity})\n")
            report.append(f"**Link BNVD:** https://bnvd.org/vulnerabilidade/{cve_id}\n")
        else:
            report.append("_Dados não disponíveis no BNVD._\n")

        report.append(f"**Link do Alerta no GitHub:** {alert.get('url', '#')}\n")
        report.append("\n---\n")

    return '\n'.join(report)

def main():
    """Função principal da Action."""
    # --- Coleta de Inputs ---
    github_token = os.environ.get('INPUT_GITHUB_TOKEN')
    bnvd_api_url = os.environ.get('INPUT_BNVD_API_URL', 'https://bnvd.org.br/api/v1')
    include_translations = os.environ.get('INPUT_INCLUDE_TRANSLATIONS', 'true').lower() == 'true'
    severity_filter = os.environ.get('INPUT_SEVERITY_FILTER', 'ALL').upper()
    repo_name = os.environ.get('GITHUB_REPOSITORY')

    # --- Inicialização ---
    if not github_token:
        print("Erro: O input `github_token` é obrigatório.")
        exit(1)
        
    g = Github(github_token)
    repo = g.get_repo(repo_name)

    # --- Coleta de Alertas ---
    dependabot_alerts = get_dependabot_alerts(repo)
    codeql_alerts = get_codeql_alerts(repo)
    all_alerts = dependabot_alerts + codeql_alerts
    
    print(f"\nTotal de {len(all_alerts)} alertas com CVE encontrados.")

    # --- Enriquecimento e Filtragem ---
    enriched_alerts = []
    for alert in all_alerts:
        if not filter_by_severity(alert['severity'], severity_filter):
            continue

        print(f"Processando {alert['cve_id']} (Severidade: {alert['severity']})...")
        bnvd_data = get_bnvd_data(alert['cve_id'], bnvd_api_url, include_translations)
        
        if bnvd_data:
            # Extrai o score CVSS para ordenação e informação
            cvss_score = 0.0
            cvss_severity = "N/A"
            for version in ['cvssMetricV31', 'cvssMetricV30', 'cvssMetricV2']:
                metrics = bnvd_data.get('cvss_metrics', {}).get(version)
                if metrics and isinstance(metrics, list):
                    cvss_data = metrics[0].get('cvssData', {})
                    cvss_score = cvss_data.get('baseScore', 0.0)
                    cvss_severity = cvss_data.get('baseSeverity', 'N/A')
                    break
            bnvd_data['cvss_score'] = cvss_score
            bnvd_data['cvss_severity'] = cvss_severity

        alert['bnvd_data'] = bnvd_data
        enriched_alerts.append(alert)

    print(f"\n{len(enriched_alerts)} alertas correspondem ao filtro de severidade e foram processados.")

    # --- Geração do Relatório ---
    report_content = generate_report(enriched_alerts, repo_name)
    report_filename = 'bnvd-security-report.md'
    
    # GITHUB_WORKSPACE é o diretório raiz do checkout do repositório.
    workspace_dir = os.environ.get("GITHUB_WORKSPACE", ".")
    report_filepath = os.path.join(workspace_dir, report_filename)

    with open(report_filepath, 'w', encoding='utf-8') as f:
        f.write(report_content)
    print(f"Relatório de segurança salvo em: {report_filepath}")

    # --- Definição dos Outputs ---
    cve_details = json.dumps([
        {'cve_id': a['cve_id'], 'severity': a['severity'], 'source': a['type']} 
        for a in enriched_alerts
    ])
    
    if 'GITHUB_OUTPUT' in os.environ:
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"total_cves_found={len(all_alerts)}\n")
            f.write(f"enriched_cves={len(enriched_alerts)}\n")
            f.write(f"report_file={report_filename}\n")
            f.write(f"cve_details={cve_details}\n")
    
    print("\nExecução finalizada com sucesso!")

if __name__ == "__main__":
    main()
