name: BNVD Security Sync

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: read

jobs:
  collect-and-enrich:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Coletar alertas CodeQL via API e salvar em workspace ---
      - name: Get CodeQL Alerts
        id: codeql_fetch
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts" \
            > $GITHUB_WORKSPACE/codeql_alerts.json

      # --- Coletar alertas Dependabot via API e salvar em workspace ---
      - name: Get Dependabot Alerts
        id: dependabot_fetch
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/dependabot/alerts?state=open" \
            > $GITHUB_WORKSPACE/dependabot_alerts.json

      # --- Chama a Action que ENRIQUECE (não coleta) ---
      - name: BNVD Enricher (consulta BNVD e gera relatório)
        uses: ./.github/actions/bnvd-security-enricher
        id: bnvd_enricher
        with:
          codeql_path: ${{ github.workspace }}/codeql_alerts.json
          dependabot_path: ${{ github.workspace }}/dependabot_alerts.json
          include_pt: 'true'

      # --- Upload do relatório / artefatos ---
      - name: Upload BNVD Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bnvd-security-report
          path: bnvd_security_report.json
