name: Análise de Segurança com BNVD

on:
  workflow_dispatch:
    inputs:
      severity_filter:
        description: 'Filtra alertas por severidade (LOW, MEDIUM, HIGH, CRITICAL, ALL).'
        required: true
        default: 'ALL'
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
          - ALL
  schedule:
    - cron: '0 8 * * 1'

# PERMISSÕES CORRETAS – agora o Dependabot funciona
permissions:
  contents: read
  security-events: read
  dependabot: read

jobs:
  enrich-vulnerabilities:
    runs-on: ubuntu-latest
    name: Buscar e Enriquecer Alertas de CVE

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4

      - name: BNVD CVE Enricher
        uses: ./.github/actions/bnvd-cve-enricher
        id: bnvd-enricher
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          severity_filter: ${{ github.event.inputs.severity_filter || 'ALL' }}

      - name: Fazer Upload do Relatório como Artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-de-seguranca-bnvd
          path: bnvd-security-report.md
          retention-days: 7

      - name: Adicionar Resumo do Job ao Sumário do Workflow
        if: always()
        run: |
          echo "## Resumo da Análise de Segurança BNVD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **CVEs Totais Encontrados:** ${{ steps.bnvd-enricher.outputs.total_cves_found || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CVEs Enriquecidos (Filtro: `${{ github.event.inputs.severity_filter || 'ALL' }}`):** ${{ steps.bnvd-enricher.outputs.enriched_cves || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f bnvd-security-report.md ]; then
            echo "### Conteúdo do Relatório:" >> $GITHUB_STEP_SUMMARY
            cat bnvd-security-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "_Nenhum relatório foi gerado._" >> $GITHUB_STEP_SUMMARY
          fi
